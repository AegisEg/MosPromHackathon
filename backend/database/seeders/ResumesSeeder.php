<?php

namespace Database\Seeders;

use App\Models\Resume;
use App\Models\User;
use App\Models\Professions;
use App\Models\Skills;
use App\Enums\EmploymentType;
use Illuminate\Database\Seeder;

class ResumesSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // Получаем пользователей и профессии
        $users = User::where('role', 2)->get(); // 2 = JOB_SEEKER - берем всех соискателей
        $professions = Professions::all(); // Берем все профессии
        $skills = Skills::take(15)->get();

        if ($users->count() < 10 || $professions->count() < 3) {
            $this->command->warn('Недостаточно пользователей или профессий. Сначала запустите UsersSeeder и ProfessionsSeeder.');
            return;
        }

        $cities = ['Москва', 'Санкт-Петербург', 'Новосибирск', 'Екатеринбург', 'Казань', 'Нижний Новгород', 'Челябинск', 'Самара', 'Омск', 'Ростов-на-Дону'];
        $educations = ['Высшее', 'Неполное высшее', 'Среднее специальное', 'Среднее'];
        
        // Типы занятости с разными весами (некоторые будут отсутствовать - null)
        $employmentTypes = [
            EmploymentType::FULL_TIME->value,    // Полная занятость (наиболее популярная)
            EmploymentType::FULL_TIME->value,
            EmploymentType::FULL_TIME->value,
            EmploymentType::PART_TIME->value,    // Частичная занятость
            EmploymentType::PART_TIME->value,
            EmploymentType::CONTRACT->value,     // Договор
            EmploymentType::FREELANCE->value,    // Фриланс
            EmploymentType::FREELANCE->value,
            EmploymentType::INTERNSHIP->value,   // Стажировка
        ];
        $aboutTexts = [
            'Опытный специалист с многолетним стажем работы. Ответственный, коммуникабельный, готов к обучению и профессиональному росту.',
            'Мотивированный сотрудник с хорошими аналитическими способностями. Умею работать в команде и самостоятельно принимать решения.',
            'Креативный подход к решению задач, опыт работы с клиентами. Готов к переезду и командировкам.',
            'Технически подкованный специалист с опытом работы в различных сферах. Быстро обучаюсь новым технологиям.',
            'Опыт работы в крупных компаниях, знание современных инструментов и методологий. Лидерские качества и опыт управления командой.',
            'Амбициозный молодой специалист с горящими глазами и желанием развиваться. Готов работать сверхурочно и изучать новые технологии.',
            'Опытный менеджер с навыками управления проектами и командой. Отличные коммуникативные способности и знание английского языка.',
            'Специалист по цифровому маркетингу с опытом работы в социальных сетях и аналитике. Креативное мышление и внимание к деталям.',
            'Финансовый аналитик с глубокими знаниями в области инвестиций и риск-менеджмента. Математический склад ума и аналитические способности.',
            'HR-специалист с опытом подбора персонала и проведения собеседований. Психологическое образование и навыки работы с людьми.',
            'Разработчик с опытом создания веб-приложений и мобильных приложений. Знание современных фреймворков и методологий разработки.',
            'Дизайнер с портфолио успешных проектов в области графического дизайна и брендинга. Креативность и чувство стиля.',
            'Продажник с опытом работы в B2B и B2C сегментах. Навыки ведения переговоров и достижения плановых показателей.',
            'Логист с опытом организации поставок и управления складскими запасами. Знание систем учета и оптимизации процессов.',
            'Юрист с опытом работы в корпоративном праве и договорной работе. Внимание к деталям и аналитическое мышление.',
            'Бухгалтер с опытом ведения учета в различных сферах деятельности. Знание 1С и других учетных систем.',
            'Маркетолог с опытом проведения рекламных кампаний и анализа рынка. Креативное мышление и навыки работы с данными.',
            'Контент-менеджер с опытом создания текстового контента и управления социальными сетями. Грамотность и креативность.',
            'Тестировщик с опытом ручного и автоматизированного тестирования. Внимание к деталям и системный подход к работе.',
            'Системный администратор с опытом настройки и поддержки IT-инфраструктуры. Техническая грамотность и навыки решения проблем.',
            'Переводчик с опытом работы с техническими текстами и документацией. Знание нескольких иностранных языков.',
            'Копирайтер с опытом создания рекламных текстов и контента для сайтов. Креативность и знание психологии продаж.',
            'SMM-менеджер с опытом ведения аккаунтов в социальных сетях и создания вирусного контента. Креативность и понимание трендов.',
            'Аналитик данных с опытом работы с большими массивами информации и созданием отчетов. Математическое образование и навыки программирования.',
            'Менеджер по работе с клиентами с опытом решения сложных задач и поддержания долгосрочных отношений. Коммуникабельность и стрессоустойчивость.',
            'Специалист по закупкам с опытом работы с поставщиками и оптимизации затрат. Навыки ведения переговоров и аналитическое мышление.',
            'Менеджер по персоналу с опытом подбора, адаптации и развития сотрудников. Психологическое образование и навыки работы с людьми.',
            'Специалист по безопасности с опытом разработки и внедрения политик информационной безопасности. Техническая грамотность и внимание к деталям.',
            'Проект-менеджер с опытом управления сложными проектами и координации работы команд. Лидерские качества и организационные способности.',
            'Специалист по автоматизации с опытом внедрения систем автоматизации бизнес-процессов. Техническое образование и аналитическое мышление.',
            'Менеджер по развитию с опытом анализа рынка и разработки стратегий роста бизнеса. Стратегическое мышление и навыки планирования.',
            'Специалист по качеству с опытом разработки и внедрения систем менеджмента качества. Внимание к деталям и системный подход.',
            'Менеджер по маркетингу с опытом проведения исследований рынка и разработки маркетинговых стратегий. Креативность и аналитические способности.',
            'Специалист по логистике с опытом оптимизации цепочек поставок и управления складскими операциями. Аналитическое мышление и навыки планирования.',
            'Менеджер по продажам с опытом работы в сфере B2B продаж и достижения высоких результатов. Коммуникабельность и навыки ведения переговоров.',
            'Специалист по кадрам с опытом ведения кадрового делопроизводства и работы с трудовым законодательством. Внимание к деталям и знание нормативных актов.',
            'Менеджер по развитию персонала с опытом организации обучения и развития сотрудников. Психологическое образование и навыки работы с людьми.',
            'Специалист по закупкам с опытом работы с поставщиками и оптимизации закупочной деятельности. Навыки ведения переговоров и аналитическое мышление.',
            'Менеджер по маркетингу с опытом проведения рекламных кампаний и анализа эффективности маркетинговых мероприятий. Креативность и навыки работы с данными.',
            'Специалист по автоматизации с опытом внедрения CRM-систем и автоматизации бизнес-процессов. Техническое образование и навыки работы с IT-системами.'
        ];

        // Специальные описания для программистов
        $programmerAboutTexts = [
            'Опытный PHP-разработчик с глубокими знаниями Laravel и современными практиками разработки. Участвовал в создании высоконагруженных веб-приложений.',
            'Full-stack разработчик с экспертизой в JavaScript, React и Node.js. Опыт работы с микросервисной архитектурой и облачными технологиями.',
            'Python-разработчик с опытом создания API, работы с базами данных и машинным обучением. Знание Django, Flask и современных библиотек.',
            'Java-разработчик с опытом создания корпоративных приложений. Знание Spring Framework, Hibernate и принципов объектно-ориентированного программирования.',
            'C# разработчик с опытом создания десктопных и веб-приложений. Знание .NET Framework, Entity Framework и архитектурных паттернов.',
            'Frontend-разработчик с экспертизой в React, Vue.js и современными инструментами сборки. Опыт создания адаптивных и доступных интерфейсов.',
            'Backend-разработчик с опытом проектирования API и работы с базами данных. Знание Docker, Kubernetes и принципов DevOps.',
            'Мобильный разработчик с опытом создания приложений для iOS и Android. Знание React Native, Flutter и нативных технологий.',
            'DevOps-инженер с опытом настройки CI/CD, мониторинга и автоматизации развертывания. Знание Docker, Kubernetes, AWS и Azure.',
            'Системный программист с опытом работы с низкоуровневыми технологиями и оптимизации производительности. Знание C/C++ и системного программирования.',
            'Веб-разработчик с полным циклом разработки от дизайна до развертывания. Опыт работы с современными фреймворками и методологиями Agile.',
            'Разработчик игр с опытом создания 2D и 3D игр. Знание Unity, Unreal Engine и игровых движков.',
            'Data Engineer с опытом работы с большими данными и созданием ETL-процессов. Знание Python, SQL и облачных платформ.',
            'Security-разработчик с опытом создания безопасных приложений и проведения аудитов безопасности. Знание принципов информационной безопасности.',
            'Blockchain-разработчик с опытом создания смарт-контрактов и децентрализованных приложений. Знание Solidity, Web3 и криптографии.',
            'Machine Learning Engineer с опытом создания моделей машинного обучения и их внедрения в продакшн. Знание Python, TensorFlow, PyTorch.',
            'Cloud-разработчик с опытом создания масштабируемых приложений в облаке. Знание AWS, Azure, Google Cloud и серверных технологий.',
            'API-разработчик с опытом создания RESTful и GraphQL API. Знание принципов проектирования API и документации.',
            'Performance Engineer с опытом оптимизации производительности приложений и баз данных. Знание профилирования и мониторинга.',
            'Technical Lead с опытом управления командой разработки и архитектурного планирования. Лидерские качества и экспертиза в технологиях.'
        ];

        $resumes = [];
        $resumeCount = min(85, $users->count()); // Создаем до 85 резюме (25 + 40 + 20 новых программистов)

        // Найдем профессию "Программист"
        $programmerProfession = $professions->where('name', 'Программист')->first();
        
        for ($i = 0; $i < $resumeCount; $i++) {
            $user = $users[$i % $users->count()];
            
            // Для последних 20 резюме (программисты) используем специальную логику
            if ($i >= 65 && $programmerProfession) {
                $profession = $programmerProfession;
                $about = $programmerAboutTexts[($i - 65) % count($programmerAboutTexts)];
            } else {
                $profession = $professions->random();
                $about = $aboutTexts[array_rand($aboutTexts)];
            }
            
            $city = $cities[array_rand($cities)];
            $education = $educations[array_rand($educations)];
            $employmentType = $employmentTypes[array_rand($employmentTypes)]; // Случайный тип занятости
            
            // Генерируем случайную дату рождения (от 18 до 65 лет)
            $age = rand(18, 65);
            $birthYear = date('Y') - $age;
            $birthMonth = rand(1, 12);
            $birthDay = rand(1, 28);
            $dateOfBirth = sprintf('%04d-%02d-%02d', $birthYear, $birthMonth, $birthDay);
            
            // Генерируем случайный телефон
            $phone = '+7 (' . rand(900, 999) . ') ' . rand(100, 999) . '-' . rand(10, 99) . '-' . rand(10, 99);
            
            // Генерируем случайную зарплату в зависимости от профессии
            $baseSalary = rand(40000, 200000);
            $salary = round($baseSalary / 1000) * 1000; // Округляем до тысяч
            
            $resumes[] = [
                'user_id' => $user->id,
                'date_of_birth' => $dateOfBirth,
                'city' => $city,
                'country' => 'Россия',
                'education' => $education,
                'employment_type' => $employmentType, // Добавляем тип занятости
                'phone' => $phone,
                'about' => $about,
                'profession_id' => $profession->id,
                'salary' => $salary,
                'status' => rand(0, 1) == 1, // Случайный статус
            ];
        }

        // Найдем навыки программистов
        $programmerSkills = Skills::whereIn('name', [
            'PHP', 'JavaScript', 'Python', 'C#', 'Java', 'Git', 'Docker', 'MySQL', 'Laravel', 'React'
        ])->get();

        foreach ($resumes as $index => $resumeData) {
            $resume = Resume::create($resumeData);
            
            // Для резюме программистов (последние 20) привязываем навыки программистов
            if ($index >= 65 && $programmerSkills->count() > 0) {
                // Привязываем все навыки программистов плюс несколько случайных общих навыков
                $allSkills = $programmerSkills->merge($skills->whereNotIn('name', [
                    'PHP', 'JavaScript', 'Python', 'C#', 'Java', 'Git', 'Docker', 'MySQL', 'Laravel', 'React'
                ])->random(rand(2, 5)));
                $resume->skills()->sync($allSkills->pluck('id'));
            } else {
                // Для обычных резюме привязываем случайные навыки
                if ($skills->count() > 0) {
                    $randomSkills = $skills->random(rand(3, min(8, $skills->count())));
                    $resume->skills()->sync($randomSkills->pluck('id'));
                }
            }
        }

        $this->command->info('Создано ' . count($resumes) . ' резюме');
    }
}
